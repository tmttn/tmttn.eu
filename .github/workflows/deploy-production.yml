name: Deploy to Production

on:
  workflow_run:
    workflows: ["CI"]
    types:
      - completed
    branches: [main]

jobs:
  deploy-to-production:
    name: Deploy to Production Branch
    runs-on: ubuntu-latest
    
    # Only run if CI workflow succeeded
    if: github.event.workflow_run.conclusion == 'success'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Fetch full history for merging
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '22.x'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci --frozen-lockfile
    
    - name: Build current main branch
      run: npm run build
    
    - name: Store current build artifacts
      run: |
        echo "📦 Storing current build artifacts..."
        mkdir -p /tmp/current-build
        cp -r out/* /tmp/current-build/
        echo "Current build size: $(du -sh /tmp/current-build/)"
    
    - name: Configure Git
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
    
    - name: Check production branch and compare builds
      id: build-comparison
      run: |
        echo "🔍 Checking if production branch exists and comparing builds..."
        
        # Fetch the latest main branch
        git fetch origin main
        git checkout main
        
        BUILD_CHANGED=true
        
        # Check if production branch exists
        if git ls-remote --exit-code --heads origin production; then
          echo "Production branch exists, checking for build differences..."
          git fetch origin production
          git checkout production
          
          # Build the current production branch
          npm run build
          
          # Compare meaningful content (excluding Next.js build-specific artifacts)
          echo "Comparing build content (excluding Next.js build IDs and hashes)..."
          
          # Function to create content hash excluding build-specific elements
          create_content_hash() {
            local dir=$1
            local output_file=$2
            
            # Hash all non-build-specific files
            find "$dir" -type f \
              ! -path "*/_next/static/*/pages/*" \
              ! -path "*/_next/static/*/chunks/*" \
              ! -path "*/_next/static/chunks/*" \
              ! -name "*.js.map" \
              ! -name "*buildManifest.js" \
              ! -name "*ssgManifest.js" \
              -exec sh -c '
                case "$1" in
                  *.html)
                    # Normalize build IDs in HTML
                    sed "s/_next\/static\/[a-zA-Z0-9_-]*\//_next\/static\/BUILD_ID\//g" "$1" | \
                    sed "s/\"buildId\":\"[^\"]*\"/\"buildId\":\"BUILD_ID\"/g"
                    ;;
                  *.js)
                    # Skip JS files with build IDs in filename
                    if echo "$1" | grep -q "_next/static/[^/]*/"; then
                      echo "# BUILD_SPECIFIC_JS_FILE"
                    else
                      cat "$1"
                    fi
                    ;;
                  *)
                    cat "$1"
                    ;;
                esac
              ' _ {} \; | sort | md5sum > "$output_file"
          }
          
          # Create content hashes
          create_content_hash "/tmp/current-build" "/tmp/current-hash"
          create_content_hash "out" "/tmp/production-hash"
          
          # Compare content hashes
          if diff /tmp/current-hash /tmp/production-hash > /dev/null 2>&1; then
            echo "✅ Build content is functionally identical - no deployment needed"
            echo "Only Next.js build IDs and internal hashes differ"
            BUILD_CHANGED=false
          else
            echo "🔄 Build content differs - deployment needed"
            echo "Meaningful content changes detected"
            BUILD_CHANGED=true
          fi
          
          # Clean up hash files
          rm -f /tmp/current-hash /tmp/production-hash
        else
          echo "Production branch doesn't exist - deployment needed"
          BUILD_CHANGED=true
        fi
        
        echo "build_changed=$BUILD_CHANGED" >> $GITHUB_OUTPUT
        
        # Switch back to main for deployment
        git checkout main
    
    - name: Deploy to production
      if: steps.build-comparison.outputs.build_changed == 'true'
      run: |
        echo "🚀 Starting deployment to production branch..."
        
        # Fetch the latest main branch
        git fetch origin main
        git checkout main
        
        # Fetch production branch (create if doesn't exist)
        if git ls-remote --exit-code --heads origin production; then
          echo "Production branch exists, fetching..."
          git fetch origin production
          git checkout production
          
          # Check if we're already up to date
          if git merge-base --is-ancestor origin/main HEAD; then
            echo "Production is already up to date with main"
            exit 0
          fi
          
          # Try to fast-forward first
          echo "Attempting fast-forward merge..."
          if git merge --ff-only origin/main; then
            echo "Successfully fast-forwarded production to main"
          else
            echo "Fast-forward not possible, performing rebase..."
            # Reset to remote state first to avoid conflicts
            git reset --hard origin/production
            if ! git rebase origin/main; then
              echo "❌ Rebase failed. This may indicate conflicts that need manual resolution."
              echo "Aborting rebase and exiting..."
              git rebase --abort
              exit 1
            fi
          fi
        else
          echo "Production branch doesn't exist, creating..."
          git checkout -b production
        fi
        
        # Push to production (force push if needed for deployment)
        echo "Pushing to production branch..."
        if ! git push origin production; then
          echo "Normal push failed, attempting force push for deployment..."
          git push --force origin production
        fi
        
        echo "✅ Successfully deployed to production branch"
    
    - name: Skip deployment (no build changes)
      if: steps.build-comparison.outputs.build_changed == 'false'
      run: |
        echo "⏭️ Skipping deployment - no changes in build artifacts"
        echo "The website content is identical to what's already in production."
    
    - name: Create deployment summary (deployed)
      if: steps.build-comparison.outputs.build_changed == 'true'
      run: |
        echo "## 🚀 Production Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Source Branch**: main" >> $GITHUB_STEP_SUMMARY
        echo "- **Target Branch**: production" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit**: ${{ github.event.workflow_run.head_sha }}" >> $GITHUB_STEP_SUMMARY
        echo "- **CI Run**: [${{ github.event.workflow_run.html_url }}](${{ github.event.workflow_run.html_url }})" >> $GITHUB_STEP_SUMMARY
        echo "- **Status**: ✅ Deployed (build artifacts changed)" >> $GITHUB_STEP_SUMMARY
        echo "- **Result**: Production branch updated, Netlify will deploy changes" >> $GITHUB_STEP_SUMMARY
    
    - name: Create deployment summary (skipped)
      if: steps.build-comparison.outputs.build_changed == 'false'
      run: |
        echo "## ⏭️ Production Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Source Branch**: main" >> $GITHUB_STEP_SUMMARY
        echo "- **Target Branch**: production" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit**: ${{ github.event.workflow_run.head_sha }}" >> $GITHUB_STEP_SUMMARY
        echo "- **CI Run**: [${{ github.event.workflow_run.html_url }}](${{ github.event.workflow_run.html_url }})" >> $GITHUB_STEP_SUMMARY
        echo "- **Status**: ⏭️ Skipped (no build changes)" >> $GITHUB_STEP_SUMMARY
        echo "- **Result**: Build artifacts identical, no Netlify deployment needed" >> $GITHUB_STEP_SUMMARY