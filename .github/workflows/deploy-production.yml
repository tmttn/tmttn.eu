name: Deploy to Production

on:
  workflow_run:
    workflows: ["CI"]
    types:
      - completed
    branches: [main]

jobs:
  deploy-to-production:
    name: Deploy to Production Branch
    runs-on: ubuntu-latest
    
    # Only run if CI workflow succeeded
    if: github.event.workflow_run.conclusion == 'success'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Fetch full history for merging
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Configure Git
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
    
    - name: Deploy to production
      run: |
        echo "ðŸš€ Starting deployment to production branch..."
        
        # Fetch the latest main branch
        git fetch origin main
        git checkout main
        
        # Fetch production branch (create if doesn't exist)
        if git ls-remote --exit-code --heads origin production; then
          echo "Production branch exists, fetching..."
          git fetch origin production
          git checkout production
        else
          echo "Production branch doesn't exist, creating..."
          git checkout -b production
        fi
        
        # Reset production to match main (no merge commits)
        echo "Resetting production to match main..."
        git reset --hard origin/main
        
        # Push to production
        echo "Pushing to production branch..."
        git push origin production
        
        echo "âœ… Successfully deployed to production branch"
    
    - name: Create deployment summary
      run: |
        echo "## ðŸš€ Production Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Source Branch**: main" >> $GITHUB_STEP_SUMMARY
        echo "- **Target Branch**: production" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit**: ${{ github.event.workflow_run.head_sha }}" >> $GITHUB_STEP_SUMMARY
        echo "- **CI Run**: [${{ github.event.workflow_run.html_url }}](${{ github.event.workflow_run.html_url }})" >> $GITHUB_STEP_SUMMARY
        echo "- **Status**: âœ… Success" >> $GITHUB_STEP_SUMMARY